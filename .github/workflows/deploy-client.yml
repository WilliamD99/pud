name: Deploy Payload Client

on:
  workflow_dispatch:
    inputs:
      client_id:
        description: 'Client ID (used for S3 prefix and IAM username)'
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: AWS
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      CLIENT: ${{ github.event.inputs.client_id }}

    steps:
      # 1. Checkout code
      - uses: actions/checkout@v3

      # 2. Configure AWS CLI
      - name: Configure AWS CLI
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 3. Create IAM user & keys (idempotent)
      - name: Create IAM user & keys
        id: iam
        run: |
          set -euo pipefail

          USER="payload-$CLIENT"

          aws iam create-user --user-name "$USER" 2>/dev/null || true

          # Delete existing access keys (IAM limit safety)
          for KEY in $(aws iam list-access-keys \
            --user-name "$USER" \
            --query 'AccessKeyMetadata[].AccessKeyId' \
            --output text); do
            aws iam delete-access-key --user-name "$USER" --access-key-id "$KEY"
          done

          # Policy
          cat > policy.json <<EOF
          {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Action": ["s3:GetObject","s3:PutObject","s3:DeleteObject"],
                "Resource": "arn:aws:s3:::shared-bucket/free/$CLIENT/*"
              },
              {
                "Effect": "Allow",
                "Action": "s3:ListBucket",
                "Resource": "arn:aws:s3:::shared-bucket",
                "Condition": {
                  "StringLike": {
                    "s3:prefix": "free/$CLIENT/*"
                  }
                }
              }
            ]
          }
          EOF

          aws iam put-user-policy \
            --user-name "$USER" \
            --policy-name "payload-s3-$CLIENT" \
            --policy-document file://policy.json

          aws iam create-access-key --user-name "$USER" > keys.json

          echo "access_key=$(jq -r .AccessKey.AccessKeyId keys.json)" >> $GITHUB_OUTPUT
          echo "secret_key=$(jq -r .AccessKey.SecretAccessKey keys.json)" >> $GITHUB_OUTPUT

      # 4. Install Vercel CLI
      - name: Install Vercel CLI
        run: npm install -g vercel

      # 5. Create Vercel project + get project ID
      - name: Create & resolve Vercel project
        id: vercel
        run: |
          set -euo pipefail
      
          PROJECT_NAME="payload-$CLIENT"
          TOKEN="${{ secrets.VERCEL_TOKEN }}"
          SCOPE="${{ secrets.VERCEL_TEAM_ID }}"
      
          vercel project add "$PROJECT_NAME" --token "$TOKEN"
      
          PROJECT_ID=$(vercel project ls --json \
            --token "$TOKEN" \
            | jq -r ".[] | select(.name==\"$PROJECT_NAME\") | .id")
      
          if [ -z "$PROJECT_ID" ] || [ "$PROJECT_ID" = "null" ]; then
            echo "âŒ Failed to resolve Vercel project ID"
            exit 1
          fi
      
          echo "project_id=$PROJECT_ID" >> $GITHUB_OUTPUT


      # 6. Link repo to Vercel project
      - name: Link Vercel project
        run: |
          vercel link --yes \
            --project ${{ steps.vercel.outputs.project_id }} \
            --scope ${{ secrets.VERCEL_TEAM_ID }} \
            --token ${{ secrets.VERCEL_TOKEN }}

      # 7. Inject env vars into Vercel
      - name: Add env vars to Vercel
        run: |
          set -euo pipefail

          TOKEN="${{ secrets.VERCEL_TOKEN }}"
          SCOPE="${{ secrets.VERCEL_TEAM_ID }}"

          echo "${{ steps.iam.outputs.access_key }}" \
            | vercel env add S3_ACCESS_KEY production --yes --token "$TOKEN" --scope "$SCOPE"

          echo "${{ steps.iam.outputs.secret_key }}" \
            | vercel env add S3_SECRET_KEY production --yes --token "$TOKEN" --scope "$SCOPE"

          echo "shared-bucket" \
            | vercel env add S3_BUCKET production --yes --token "$TOKEN" --scope "$SCOPE"

          echo "free/$CLIENT" \
            | vercel env add S3_BUCKET_PREFIX production --yes --token "$TOKEN" --scope "$SCOPE"

      # 8. Deploy
      - name: Deploy Payload to Vercel
        run: |
          vercel deploy --prod \
            --token ${{ secrets.VERCEL_TOKEN }} \
            --scope ${{ secrets.VERCEL_TEAM_ID }}

  cleanup:
    if: failure()
    runs-on: ubuntu-latest
    environment: AWS
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      CLIENT: ${{ github.event.inputs.client_id }}

    steps:
      - name: Configure AWS CLI
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Cleanup IAM resources
        run: |
          set -euo pipefail

          USER="payload-$CLIENT"

          for KEY in $(aws iam list-access-keys \
            --user-name "$USER" \
            --query 'AccessKeyMetadata[].AccessKeyId' \
            --output text); do
            aws iam delete-access-key --user-name "$USER" --access-key-id "$KEY"
          done

          aws iam delete-user-policy \
            --user-name "$USER" \
            --policy-name "payload-s3-$CLIENT" || true

          aws iam delete-user --user-name "$USER" || true
